
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>CarrollOps</title>
  <meta name="author" content="Jeremy Carroll">

  
  <meta name="description" content="In my first blog post I went over setting up a simple fair scheduler monitoring script using mechanize to scrape stats from the JobTracker page. Now &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.carrollops.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="CarrollOps" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<!-- Load jQuery -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
    jQuery.noConflict(); // ender.js conflicts with jQuery
</script>

<!-- Load FancyBox -->
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" />
<script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>

<!-- Fix FancyBox style for OctoPress -->
<style type="text/css">
  .fancybox-wrap { position: fixed !important; }
  .fancybox-opened {
    -webkit-border-radius: 4px !important;
       -moz-border-radius: 4px !important;
            border-radius: 4px !important;
  }
  .fancybox-close, .fancybox-prev span, .fancybox-next span {
    background-color: transparent !important;
    border: 0 !important;
  }
</style>


<!-- Custom Scripts -->
<script language="Javascript" type="text/javascript">
    // ender.js gobbles jQuery's ready event: Use ender.js $ instead
    $(document).ready(function() {
        jQuery(".fancybox").fancybox();
    });
</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-33925204-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText">ops</div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">CarrollOps</a></h1>
  
    <h2>A Blog by Jeremy Carroll</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.carrollops.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/08/10/hadoop-fair-scheduler-monitoring-part-2/">Hadoop Fair Scheduler Monitoring - Part 2</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-08-10T08:44:00-07:00" pubdate data-updated="true">Aug 10<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my first blog post I went over setting up a simple fair scheduler monitoring script using mechanize to scrape stats from the JobTracker page. Now that all the metrics are in our graphite system (In this case, I used graphite due to nice front-end vis) I wanted to show how we can put these metrics to work.</p>

<p>The goal was to measure requests for resources (Map slots / Reduce slots) for different job queues. I can then determine certain parts of the day where there is a lot of contention for resources to see if a job can be rescheduled to a different time when there is more slots available. Another option would be to change the fair-scheduler minShare, preemption, and weight settings to help shape the SLA of running jobs. Before we can start setting these policies it would be nice to know map / reduce slot demand over a timeline. Also look at &#8216;running&#8217; map / reduce slots to see what resources the scheduler gave during those time periods. Here are some questions the metrics can answer for us.</p>

<ul>
<li>During what times of the day is the cluster heavily over-subscribed?

<ul>
<li>Is the cluster using more map or reduce slots during these timeframes?</li>
</ul>
</li>
<li>What queues / users are requesting resources?

<ul>
<li>How many jobs are they running?</li>
<li>How many Map / Reduce slots are they requesting?</li>
<li>How fast are they completing map / reduce slots?</li>
</ul>
</li>
</ul>


<p>I put together a series of visualizations to help debug an oversubscribed Hadoop cluster. Using this information was invaluable in determining winners and losers of cluster resources. It did not help debug individual MapReduce jobs. You would have to look at individual job performance such as spilling to disk, not using a combiner or secondary sort, or sending too much data uncompressed over the wire, etc&#8230; But it does help determine overall cluster utilization.</p>

<p><a href="http://www.carrollops.com/images/fair_sched_2_demand.png" class="fancybox" title="Demand "><img src="http://www.carrollops.com/images/fair_sched_2_demand_m.png" alt="Demand " /></a>
<a href="http://www.carrollops.com/images/fair_sched_2_jobs.png" class="fancybox" title="Jobs "><img src="http://www.carrollops.com/images/fair_sched_2_jobs_m.png" alt="Jobs " /></a>
<a href="http://www.carrollops.com/images/fair_sched_2_map_slots.png" class="fancybox" title="Map Slots "><img src="http://www.carrollops.com/images/fair_sched_2_map_slots_m.png" alt="Map Slots " /></a>
<a href="http://www.carrollops.com/images/fair_sched_2_maps_speed.png" class="fancybox" title="Map Speed "><img src="http://www.carrollops.com/images/fair_sched_2_maps_speed_m.png" alt="Map Speed " /></a>
<a href="http://www.carrollops.com/images/fair_sched_2_queue.png" class="fancybox" title="Queue "><img src="http://www.carrollops.com/images/fair_sched_2_queue_m.png" alt="Queue " /></a>
<a href="http://www.carrollops.com/images/fair_sched_2_reduce_slots.png" class="fancybox" title="Reduce Slots "><img src="http://www.carrollops.com/images/fair_sched_2_reduce_slots_m.png" alt="Reduce Slots " /></a>
<a href="http://www.carrollops.com/images/fair_sched_2_queue_info.png" class="fancybox" title="Queue Info "><img src="http://www.carrollops.com/images/fair_sched_2_queue_info_m.png" alt="Queue Info " /></a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/08/07/hadoop-fair-scheduler-monitoring/">Hadoop Fair Scheduler Monitoring</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-08-07T15:23:00-07:00" pubdate data-updated="true">Aug 7<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So today I received a request to help debug fair scheduler performance on one of our large Hadoop clusters. Normally this is the point where I would point to installing a tool like Cloudera Manager, but we do not have CM running anywhere within our environment. So I took a quick look around GitHub to see if anybody has written any scripts to monitor the fair scheduler allocations and found nothing. We currently have monitoring on the Hadoop / HDFS level, but are lacking visibility at the individual scheduler / pool level. Questions arise such as this that I cannot answer without a cool made-up story.</p>

<ul>
<li>My job ran very slow last night, can you take a look at the cluster to see if anything is wrong?</li>
<li>This set of Oozie jobs normally takes 2 hours, but over the past few days it has been taking 4 hours easy run, why is that?</li>
<li>Can you check the network? Looks like my jobs have been running very slowly.</li>
</ul>


<p>Now at this point, I check the regular cluster health with our fleet of monitoring tools based on Graphite / OpenTSDB. Looking at HDFS health, I see no instances of failed datanodes, 100 mbit links, errors in the log files, et al. While looking at basic hadoop-metrics from our logging context, I see that the cluster is almost always 100% utilized on map slots / reduce slots. The next obvious question is &#8216;Who is running jobs stealing my resources?&#8217;. Before I can start to create fair-share policies, and pick winners and losers of precious cluster resources via preemption I need to know demand. I need to know how many jobs are running in each pool, and how many slots they require to finish there tasks. I would also love to monitor preemption requests to see when pools start killing other tasks to meet their fair-share or min-share. I set out to create a simple tool to query the http://jobtracker:50030/scheduler?advanced web interface on a timer, and send this metadata to Graphite / OpenTSDB on a real-time basis. I could then create visualizations to see demand and allocation to help craft fair share policies. It&#8217;s not perfect as it does not look at individual job performance (Input splits, min / max task completion time) but is really helpful on a high level.</p>

<p>I wanted something quick and easy to get done, so I took about 2 hours to create a Ruby Mechanize script to screen scrape the jobtracker fair-scheduler page. I then turn the output into a KeyValue format that I can use with OpenTSDB / Graphite. I did not want to create a lot of unique keys due to issues with Graphite creating a Whisper database per unique point. So capturing job-name, task-id is unacceptable. I instead aggregate metrics by user, or pool. In the case of our cluster job pool names are users. So I aggreagte the metrics by pool name, then send off to our visualiation system for further planning.</p>

<ul>
<li><a href="https://github.com/phobos182/hadoop-hbase-tools">https://github.com/phobos182/hadoop-hbase-tools</a></li>
</ul>


<p>I created a project above if you would like to hack on the code. Currently I am using Diamond <a href="https://github.com/BrightcoveOS/Diamond">https://github.com/BrightcoveOS/Diamond</a> to schedule checks via the UserScriptsCollector for ruby programs. It wants Key + Value, and fills in the date for you based on your scheduler. I can then send the metrics to both OpenTSDB + Graphite with the same system via Handlers. Below is some graphs of the things you can do with this information.</p>

<p><img class="left" src="http://www.carrollops.com/images/graphite_fair_scheduler.png" width="351" height="140" title="'Fair scheduler' #2" >
As you can see by the graph, it details a nice break down of slots utilization by fair scheduler pool. In this image, 3 different pools are racing for resources as the cluster is 100% utilized. You can dive into other metrics such as total tasks scheduled (map / reduce) vs. resources available at that time. Let me know if you find this tool helpful. Pull requests are always welcome.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/08/06/open-sourcing-some-work/">Open Sourcing Some Work</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-08-06T12:37:00-07:00" pubdate data-updated="true">Aug 6<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve made it a point to start contributing more of my work back to the open source community i&#8217;ve gained so much from. So in next few days with permission from my employer, I am going to start contributing some simple tools that have made my life easier over here at Klout. Here is a list of some of the things i&#8217;m working on.</p>

<ul>
<li>Storm Puppet module</li>
<li>Storm debian packaging</li>
<li>HBase rolling compact tool with ZooKeeper locks</li>
<li>HBase major_compaction script with ZooKeeper locks</li>
<li>HBase metrics collection script</li>
<li>HBase per-table load balancing calculation script</li>
<li>Hadoop GraphiteClient context</li>
<li>Kafka JMX Monitoring script</li>
<li>Diamond handler for Kafka</li>
<li>OpenTSDB GnuPlot options</li>
<li>MCollective Monit agent</li>
<li>Hadoop hiera puppet module</li>
<li>HBase hiera puppet module</li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/08/10/hadoop-fair-scheduler-monitoring-part-2/">Hadoop Fair Scheduler Monitoring - Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/07/hadoop-fair-scheduler-monitoring/">Hadoop Fair Scheduler monitoring</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/06/open-sourcing-some-work/">Open sourcing some work</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("jeremy_carroll", 5, true);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/jeremy_carroll" class="twitter-follow-button" data-show-count="false">Follow @jeremy_carroll</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Jeremy Carroll -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'carrollops';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
